<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiny Invoicing - Modern Billing</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #0d6efd;
            --bg-light: #f8f9fa;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: #333;
        }

        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .card-modern {
            border: none;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            width: 100%;
            max-width: 450px;
            background: white;
            overflow: hidden;
        }

        .card-header-modern {
            background-color: var(--primary-color);
            color: white;
            padding: 30px;
            text-align: center;
            border: none;
        }

        .card-body-modern {
            padding: 40px;
        }

        .btn-modern {
            border-radius: 8px;
            padding: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .form-control-modern {
            border-radius: 8px;
            padding: 12px;
            border: 1px solid #dee2e6;
            margin-bottom: 5px;
        }

        .form-control-modern:focus {
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15);
            border-color: var(--primary-color);
        }

        .hidden { display: none !important; }

        /* Dashboard Styles */
        .dashboard-nav {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 15px 0;
            margin-bottom: 30px;
        }

        .invoice-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            transition: transform 0.2s;
        }

        .invoice-card:hover {
            transform: translateY(-2px);
        }

        .badge-status {
            font-size: 0.8rem;
            padding: 5px 10px;
            border-radius: 20px;
        }

        .section-title {
            font-weight: 700;
            margin-bottom: 25px;
            position: relative;
            display: inline-block;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 40px;
            height: 3px;
            background: var(--primary-color);
        }
    </style>
</head>
<body>

    <!-- Auth Section (Login & Admin Setup) -->
    <div id="auth-section" class="auth-container">
        <div class="card-modern">
            <div class="card-header-modern">
                <i class="fas fa-file-invoice-dollar fa-3x mb-3"></i>
                <h3 class="mb-0 fw-bold">Tiny Invoicing</h3>
                <p class="mb-0 opacity-75">Management Made Simple</p>
            </div>
            
            <div class="card-body-modern">
                <!-- Login Tab -->
                <div id="login-tab">
                    <h5 class="fw-bold mb-4 text-center">User Login</h5>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Username</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-0"><i class="fas fa-user text-muted"></i></span>
                            <input type="text" id="login-username" class="form-control form-control-modern border-0 bg-light" placeholder="Enter username">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="form-label small fw-bold">Password</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-0"><i class="fas fa-lock text-muted"></i></span>
                            <input type="password" id="login-password" class="form-control form-control-modern border-0 bg-light" placeholder="Enter password">
                        </div>
                    </div>
                    <button onclick="login()" class="btn btn-primary btn-modern w-100 mb-3 shadow-sm">
                        Login to Dashboard
                    </button>
                    <div class="text-center">
                        <a href="javascript:void(0)" onclick="toggleAuthMode(true)" class="text-decoration-none small">Setup Admin Account</a>
                    </div>
                </div>

                <!-- Admin Setup Tab (Hidden by default) -->
                <div id="admin-setup-tab" class="hidden">
                    <h5 class="fw-bold mb-4 text-center">Admin Registration</h5>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">New Username</label>
                        <input type="text" id="admin-username" class="form-control form-control-modern bg-light border-0" value="admin">
                    </div>
                    <div class="mb-4">
                        <label class="form-label small fw-bold">New Password</label>
                        <input type="password" id="admin-password" class="form-control form-control-modern bg-light border-0" value="password">
                    </div>
                    <button onclick="createAdminUser()" class="btn btn-outline-primary btn-modern w-100 mb-3">
                        Register Admin
                    </button>
                    <div class="text-center">
                        <a href="javascript:void(0)" onclick="toggleAuthMode(false)" class="text-decoration-none small">Back to Login</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- App/Dashboard Section (Hidden by default) -->
    <div id="app-section" class="hidden">
        <nav class="dashboard-nav">
            <div class="container d-flex justify-content-between align-items-center">
                <span class="fw-bold fs-4 text-primary"><i class="fas fa-file-invoice-dollar me-2"></i>TinyInv</span>
                <div>
                    <span id="user-display" class="me-3 small text-muted"></span>
                    <button onclick="logout()" class="btn btn-sm btn-outline-danger rounded-pill px-3">Logout</button>
                </div>
            </div>
        </nav>

        <div class="container py-4">
            <div class="row g-4">
                <!-- Left: List -->
                <div class="col-lg-7">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="section-title">Invoice History</h4>
                        <button onclick="getInvoices()" class="btn btn-light btn-sm shadow-sm">
                            <i class="fas fa-sync-alt me-1"></i> Refresh
                        </button>
                    </div>
                    <div id="invoices-list">
                        <!-- Invoice Cards -->
                    </div>
                </div>

                <!-- Right: Create Form -->
                <div class="col-lg-5">
                    <div class="card border-0 shadow-sm rounded-4 p-4">
                        <h4 class="section-title">New Invoice</h4>
                        
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted text-uppercase">Client Details</label>
                            <div class="input-group mb-2">
                                <span class="input-group-text bg-white border-end-0"><i class="fas fa-hashtag text-muted"></i></span>
                                <input type="number" id="client-id" class="form-control border-start-0" placeholder="Client ID" value="1">
                            </div>
                        </div>

                        <div class="row g-2 mb-4">
                            <div class="col-6">
                                <label class="form-label small fw-bold text-muted text-uppercase">Issue Date</label>
                                <input type="date" id="issue-date" class="form-control border-0 bg-light">
                            </div>
                            <div class="col-6">
                                <label class="form-label small fw-bold text-muted text-uppercase">Due Date</label>
                                <input type="date" id="due-date" class="form-control border-0 bg-light">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted text-uppercase d-flex justify-content-between">
                                Items 
                                <a href="javascript:void(0)" onclick="addInvoiceItem()" class="text-decoration-none">+ Add Item</a>
                            </label>
                            <div id="invoice-items" class="bg-light p-3 rounded-3" style="max-height: 300px; overflow-y: auto;">
                                <!-- Item fields -->
                            </div>
                        </div>

                        <button onclick="createInvoice()" class="btn btn-primary btn-modern w-100 mt-2 shadow">
                            <i class="fas fa-paper-plane me-2"></i>Generate Invoice
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let authToken = null;

        function toggleAuthMode(isAdmin) {
            document.getElementById('login-tab').classList.toggle('hidden', isAdmin);
            document.getElementById('admin-setup-tab').classList.toggle('hidden', !isAdmin);
        }

        function createAdminUser() {
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;

            fetch('/api/admin/create-user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message || data.error);
                if (!data.error) toggleAuthMode(false);
            })
            .catch(err => console.error('Error:', err));
        }

        function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            if(!username || !password) {
                alert("Please enter credentials");
                return;
            }

            authToken = 'Basic ' + btoa(username + ':' + password);
            document.getElementById('user-display').textContent = 'Logged in as: ' + username;
            
            // UI Transition
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');
            getInvoices();
        }

        function logout() {
            authToken = null;
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('app-section').classList.add('hidden');
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
        }

        function getInvoices() {
            if (!authToken) return;

            fetch('/api/invoices', {
                headers: { 'Authorization': authToken }
            })
            .then(response => {
                if (response.status === 401) {
                    throw new Error("UNAUTHORIZED");
                }
                if (!response.ok) {
                    throw new Error("SERVER_ERROR");
                }
                return response.json();
            })
            .then(invoices => {
                const list = document.getElementById('invoices-list');
                list.innerHTML = '';
                
                if(!invoices || invoices.length === 0) {
                    list.innerHTML = `
                        <div class="text-center py-5 text-muted">
                            <i class="fas fa-ghost fa-3x mb-3 opacity-25"></i>
                            <p>No invoices found. Create your first one!</p>
                        </div>
                    `;
                    return;
                }

                invoices.forEach(inv => {
                    const statusClass = inv.status === 'paid' ? 'bg-success text-white' : 'bg-warning text-dark';
                    const card = document.createElement('div');
                    card.className = 'invoice-card d-flex justify-content-between align-items-center';
                    card.innerHTML = `
                        <div>
                            <div class="fw-bold text-primary mb-1">Invoice #${inv.id}</div>
                            <div class="small text-muted"><i class="far fa-calendar-alt me-1"></i> ${new Date(inv.issue_date).toLocaleDateString()}</div>
                        </div>
                        <div class="text-end">
                            <div class="h5 fw-bold mb-1">$${inv.total.toFixed(2)}</div>
                            <span class="badge badge-status ${statusClass}">${inv.status || 'Draft'}</span>
                        </div>
                    `;
                    list.appendChild(card);
                });
            })
            .catch(err => {
                console.error('Error:', err);
                if (err.message === "UNAUTHORIZED") {
                    alert("Login gagal: Username atau Password salah.");
                    logout();
                } else {
                    // Jangan logout jika hanya kesalahan jaringan atau data kosong
                    console.log("Could not fetch invoices, might be empty or server issue.");
                }
            });
        }

        function createInvoice() {
            if (!authToken) return;

            const clientIdInput = document.getElementById('client-id').value;
            const clientId = parseInt(clientIdInput);
            const issueDateRaw = document.getElementById('issue-date').value;
            const dueDateRaw = document.getElementById('due-date').value;

            if (isNaN(clientId)) {
                alert("Please enter a valid Client ID (number)");
                return;
            }

            if (!issueDateRaw || !dueDateRaw) {
                alert("Please select both issue and due dates");
                return;
            }

            // Backend Go expects RFC3339. Using ISO string is cleaner.
            const issueDate = new Date(issueDateRaw).toISOString();
            const dueDate = new Date(dueDateRaw).toISOString();

            const items = [];
            const itemNodes = document.querySelectorAll('.invoice-item-row');
            
            itemNodes.forEach(itemNode => {
                const description = itemNode.querySelector('.item-description').value;
                const quantity = parseInt(itemNode.querySelector('.item-quantity').value);
                const unitPrice = parseFloat(itemNode.querySelector('.item-unit-price').value);
                
                if(description && !isNaN(quantity) && !isNaN(unitPrice)) {
                    items.push({ 
                        description: description, 
                        quantity: quantity, 
                        unit_price: unitPrice 
                    });
                }
            });

            if(items.length === 0) {
                alert("Please add at least one item with valid quantity and price");
                return;
            }

            const invoicePayload = {
                customer_id: clientId,
                issue_date: issueDate,
                due_date: dueDate,
                status: "draft",
                line_items: items
            };

            console.log("Sending Payload:", invoicePayload);

            fetch('/api/invoices', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': authToken
                },
                body: JSON.stringify(invoicePayload)
            })
            .then(async response => {
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || "Failed to create invoice");
                }
                return data;
            })
            .then(data => {
                alert('Invoice generated successfully!');
                getInvoices();
                // Reset items
                document.getElementById('invoice-items').innerHTML = '';
                addInvoiceItem();
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Error: ' + err.message);
            });
        }

        function addInvoiceItem() {
            const itemsContainer = document.getElementById('invoice-items');
            const itemNode = document.createElement('div');
            itemNode.classList.add('invoice-item-row', 'bg-white', 'p-3', 'rounded-3', 'mb-3', 'shadow-sm', 'border');
            itemNode.innerHTML = `
                <div class="mb-2">
                    <input type="text" class="form-control form-control-sm item-description" placeholder="Item description">
                </div>
                <div class="row g-2">
                    <div class="col-6">
                        <input type="number" class="form-control form-control-sm item-quantity" placeholder="Qty">
                    </div>
                    <div class="col-6">
                        <input type="number" step="0.01" class="form-control form-control-sm item-unit-price" placeholder="Price">
                    </div>
                </div>
            `;
            itemsContainer.appendChild(itemNode);
        }

        // Set default dates
        document.getElementById('issue-date').valueAsDate = new Date();
        document.getElementById('due-date').valueAsDate = new Date(new Date().setDate(new Date().getDate() + 30));
        addInvoiceItem();
    </script>
</body>
</html>