<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiny Invoicing</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        .container { max-width: 800px; margin: auto; }
        .form-group { margin-bottom: 1em; }
        label { display: block; margin-bottom: 0.5em; }
        input, textarea { width: 100%; padding: 0.5em; }
        button { padding: 0.5em 1em; cursor: pointer; }
        .hidden { display: none; }
        #invoices-list { list-style: none; padding: 0; }
        #invoices-list li { padding: 0.5em; border-bottom: 1px solid #ccc; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Tiny Invoicing</h1>

        <div id="admin-user-section">
            <h2>Create Admin User (for demo)</h2>
            <div class="form-group">
                <label for="admin-username">Username</label>
                <input type="text" id="admin-username" value="admin">
            </div>
            <div class="form-group">
                <label for="admin-password">Password</label>
                <input type="password" id="admin-password" value="password">
            </div>
            <button onclick="createAdminUser()">Create Admin</button>
        </div>

        <hr>

        <div id="login-section">
            <h2>Login</h2>
            <div class="form-group">
                <label for="login-username">Username</label>
                <input type="text" id="login-username">
            </div>
            <div class="form-group">
                <label for="login-password">Password</label>
                <input type="password" id="login-password">
            </div>
            <button onclick="login()">Login</button>
        </div>

        <div id="app-section" class="hidden">
            <h2>Invoices</h2>
            <button onclick="getInvoices()">Refresh Invoices</button>
            <ul id="invoices-list"></ul>

            <hr>

            <h2>Create Invoice</h2>
            <div class="form-group">
                <label for="customer-id">Customer ID</label>
                <input type="number" id="customer-id" value="1">
            </div>
            <div class="form-group">
                <label for="issue-date">Issue Date</label>
                <input type="date" id="issue-date">
            </div>
            <div class="form-group">
                <label for="due-date">Due Date</label>
                <input type="date" id="due-date">
            </div>
            <div id="invoice-items">
                <!-- Items will be added here -->
            </div>
            <button onclick="addInvoiceItem()">Add Item</button>
            <hr>
            <button onclick="createInvoice()">Create Invoice</button>
        </div>
    </div>

    <script>
        let authToken = null;

        function createAdminUser() {
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;

            fetch('/api/admin/create-user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message || data.error);
            })
            .catch(err => console.error('Error:', err));
        }

        function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            authToken = 'Basic ' + btoa(username + ':' + password);

            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');
            getInvoices();
        }

        function getInvoices() {
            if (!authToken) return;

            fetch('/api/invoices', {
                headers: { 'Authorization': authToken }
            })
            .then(response => response.json())
            .then(invoices => {
                const list = document.getElementById('invoices-list');
                list.innerHTML = '';
                invoices.forEach(inv => {
                    const li = document.createElement('li');
                    li.textContent = `Invoice #${inv.id} - Total: ${inv.total} - Paid: ${inv.paid}`;
                    list.appendChild(li);
                });
            })
            .catch(err => console.error('Error:', err));
        }

        function createInvoice() {
            if (!authToken) return;

            const customerId = parseInt(document.getElementById('customer-id').value);
            const issueDate = document.getElementById('issue-date').value;
            const dueDate = document.getElementById('due-date').value;

            const items = [];
            let total = 0;
            const itemNodes = document.querySelectorAll('.invoice-item');
            itemNodes.forEach(itemNode => {
                const description = itemNode.querySelector('.item-description').value;
                const quantity = parseInt(itemNode.querySelector('.item-quantity').value);
                const unitPrice = parseFloat(itemNode.querySelector('.item-unit-price').value);
                const itemTotal = quantity * unitPrice;
                items.push({ description, quantity, unit_price: unitPrice, total: itemTotal });
                total += itemTotal;
            });

            const invoice = {
                customer_id: customerId,
                issue_date: issueDate,
                due_date: dueDate,
                paid: false,
                total: total,
                items: items
            };

            fetch('/api/invoices', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': authToken
                },
                body: JSON.stringify(invoice)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert('Invoice created successfully!');
                    getInvoices();
                }
            })
            .catch(err => console.error('Error:', err));
        }

        function addInvoiceItem() {
            const itemsContainer = document.getElementById('invoice-items');
            const itemNode = document.createElement('div');
            itemNode.classList.add('invoice-item');
            itemNode.innerHTML = `
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" class="item-description">
                </div>
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" class="item-quantity">
                </div>
                <div class="form-group">
                    <label>Unit Price</label>
                    <input type="number" step="0.01" class="item-unit-price">
                </div>
                <hr>
            `;
            itemsContainer.appendChild(itemNode);
        }

        // Set default dates
        document.getElementById('issue-date').valueAsDate = new Date();
        document.getElementById('due-date').valueAsDate = new Date(new Date().setDate(new Date().getDate() + 30));
        addInvoiceItem(); // Add one item by default
    </script>
</body>
</html>
